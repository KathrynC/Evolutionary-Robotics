<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Evolutionary Robotics: Experiment Designer</title>
<script>
/*
 * Minimal SugarCube-compatible engine.
 *
 * This implements enough of SugarCube 2's runtime to drive
 * tw-storydata/tw-passagedata passages with $variables, <<set>>,
 * <<if>>/<<elseif>>/<<else>>/<<endif>>, <<goto>>, <<link>>, <<button>>,
 * and wiki-style [[links]].
 *
 * It is NOT the full SugarCube engine — just enough for this story.
 */
(function () {
  "use strict";

  /* ── State ────────────────────────────────────────────────────── */
  const State = { variables: {}, _history: [] };
  window.State = State;

  /* ── Passage store ────────────────────────────────────────────── */
  const Story = { passages: {} };
  window.Story = Story;

  function loadPassages() {
    const sd = document.querySelector("tw-storydata");
    if (!sd) return;
    sd.querySelectorAll("tw-passagedata").forEach(el => {
      Story.passages[el.getAttribute("name")] = el.innerHTML
        .replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&").replace(/&quot;/g, '"');
    });
  }

  /* ── Template engine ──────────────────────────────────────────── */

  // Process <<set $var to value>> / <<set $var = value>>
  function processSet(src) {
    return src.replace(/<<set\s+([\s\S]*?)>>/g, (_, body) => {
      // support multiple assignments separated by ;
      body.split(";").forEach(stmt => {
        stmt = stmt.trim();
        if (!stmt) return;
        // $var to expr  OR  $var = expr
        const m = stmt.match(/^\$(\w+)\s+(?:to|=)\s+([\s\S]+)$/);
        if (m) {
          try {
            State.variables[m[1]] = evalExpr(m[2].trim());
          } catch (e) { console.warn("<<set>> error:", e, stmt); }
        }
      });
      return "";
    });
  }

  function evalExpr(expr) {
    // Replace $var references with State.variables.var
    let code = expr.replace(/\$(\w+)/g, "State.variables.$1");
    // Replace "eq" / "neq" / "is" / "isnot" / "and" / "or" / "not" / "gte" / "lte" / "gt" / "lt"
    code = code.replace(/\beq\b/g, "===").replace(/\bneq\b/g, "!==")
               .replace(/\bis\b/g, "===").replace(/\bisnot\b/g, "!==")
               .replace(/\band\b/g, "&&").replace(/\bor\b/g, "||").replace(/\bnot\b/g, "!")
               .replace(/\bgte\b/g, ">=").replace(/\blte\b/g, "<=")
               .replace(/\bgt\b/g, ">").replace(/\blt\b/g, "<");
    try { return Function("State", "return (" + code + ");")(State); }
    catch (e) { console.warn("evalExpr error:", e, expr); return undefined; }
  }

  // Process <<if>>..<<elseif>>..<<else>>..<<endif>> and <</if>>
  function processConditionals(src) {
    // Normalize <</if>> to <<endif>>
    src = src.replace(/<<\/if>>/g, "<<endif>>");
    let limit = 50;
    while (src.includes("<<if ") && limit-- > 0) {
      src = src.replace(/<<if\s+([\s\S]*?)>>([\s\S]*?)<<endif>>/m, (_, cond, body) => {
        // Split body on <<elseif>> and <<else>>
        const parts = [];
        let cur = { cond: cond.trim(), text: "" };
        const tokens = body.split(/(<<elseif\s+[\s\S]*?>>|<<else>>)/);
        for (let i = 0; i < tokens.length; i++) {
          const tk = tokens[i];
          const em = tk.match(/^<<elseif\s+([\s\S]*?)>>$/);
          if (em) {
            parts.push(cur);
            cur = { cond: em[1].trim(), text: "" };
          } else if (tk === "<<else>>") {
            parts.push(cur);
            cur = { cond: "true", text: "" };
          } else {
            cur.text += tk;
          }
        }
        parts.push(cur);
        for (const p of parts) {
          try {
            if (evalExpr(p.cond)) return p.text;
          } catch (e) { /* skip */ }
        }
        return "";
      });
    }
    return src;
  }

  // Process <<goto "PassageName">> / <<goto 'PassageName'>>
  function processGoto(src) {
    const m = src.match(/<<goto\s+["']([^"']+)["']\s*>>/);
    if (m) {
      setTimeout(() => Engine.play(m[1]), 0);
      return src.replace(/<<goto\s+["'][^"']+["']\s*>>/, "");
    }
    return src;
  }

  // Process <<link>> and <<button>>
  function processLinksAndButtons(src) {
    // <<link "Text" "Passage">>...optional sets...<</link>>
    // <<link "Text">><<goto "Passage">><</link>>
    // <<button "Text" "Passage">>...<</button>>
    src = src.replace(/<<(link|button)\s+"([^"]+)"\s+"([^"]+)">>([^]*?)<<\/\1>>/g,
      (_, tag, text, passage, inner) => {
        const id = "lnk_" + Math.random().toString(36).slice(2, 8);
        setTimeout(() => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("click", () => {
            // Execute inner sets
            processSet(inner);
            Engine.play(passage);
          });
        }, 0);
        return `<a id="${id}" class="link-internal" tabindex="0">${text}</a>`;
      });
    // <<link "Text">>inner with goto<</link>>
    src = src.replace(/<<(link|button)\s+"([^"]+)">>([^]*?)<<\/\1>>/g,
      (_, tag, text, inner) => {
        const id = "lnk_" + Math.random().toString(36).slice(2, 8);
        setTimeout(() => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("click", () => {
            let processed = processSet(inner);
            const gm = inner.match(/<<goto\s+["']([^"']+)["']\s*>>/);
            if (gm) Engine.play(gm[1]);
          });
        }, 0);
        return `<a id="${id}" class="link-internal" tabindex="0">${text}</a>`;
      });
    return src;
  }

  // Process [[Link Text|Passage]] and [[Passage]]
  function processWikiLinks(src) {
    // [[Text|Passage]]
    src = src.replace(/\[\[([^\]|]+)\|([^\]]+)\]\]/g, (_, text, passage) => {
      const id = "wl_" + Math.random().toString(36).slice(2, 8);
      setTimeout(() => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("click", () => Engine.play(passage.trim()));
      }, 0);
      return `<a id="${id}" class="link-internal" tabindex="0">${text}</a>`;
    });
    // [[Passage]]
    src = src.replace(/\[\[([^\]]+)\]\]/g, (_, passage) => {
      const id = "wl_" + Math.random().toString(36).slice(2, 8);
      setTimeout(() => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("click", () => Engine.play(passage.trim()));
      }, 0);
      return `<a id="${id}" class="link-internal" tabindex="0">${passage}</a>`;
    });
    return src;
  }

  // Process <<print $var>> and bare $var in text
  function processPrint(src) {
    src = src.replace(/<<print\s+([\s\S]*?)>>/g, (_, expr) => {
      try { const v = evalExpr(expr.trim()); return v !== undefined ? String(v) : ""; }
      catch (e) { return ""; }
    });
    // Bare $var (not inside << >>)  — only word-boundary delimited
    src = src.replace(/\$(\w+)/g, (match, name) => {
      if (name in State.variables) return String(State.variables[name]);
      return match;
    });
    return src;
  }

  // Process <<run expression>>
  function processRun(src) {
    return src.replace(/<<run\s+([\s\S]*?)>>/g, (_, expr) => {
      try { evalExpr(expr.trim()); } catch (e) { console.warn("<<run>> error:", e); }
      return "";
    });
  }

  // Process <<script>>...<</script>>
  function processScript(src) {
    return src.replace(/<<script>>([\s\S]*?)<<\/script>>/g, (_, code) => {
      try {
        code = code.replace(/\$(\w+)/g, "State.variables.$1");
        Function("State", code)(State);
      } catch (e) { console.warn("<<script>> error:", e); }
      return "";
    });
  }

  // Simple markup: ''bold'', //italic//, @@.class;text@@, html passthrough
  function processMarkup(src) {
    src = src.replace(/''([\s\S]*?)''/g, "<strong>$1</strong>");
    src = src.replace(/\/\/([\s\S]*?)\/\//g, "<em>$1</em>");
    // Newlines to <br> (except inside tags)
    src = src.replace(/\n/g, "<br>\n");
    return src;
  }

  function render(src) {
    src = processScript(src);
    src = processSet(src);
    src = processRun(src);
    src = processConditionals(src);
    src = processGoto(src);
    src = processLinksAndButtons(src);
    src = processWikiLinks(src);
    src = processPrint(src);
    src = processMarkup(src);
    return src;
  }

  /* ── Engine ───────────────────────────────────────────────────── */
  const Engine = {
    play(name) {
      const src = Story.passages[name];
      if (src === undefined) {
        console.error("Passage not found:", name);
        document.getElementById("passages").innerHTML =
          `<div class="passage"><h2>Error</h2><p>Passage "${name}" not found.</p></div>`;
        return;
      }
      State._history.push(name);
      // Update lens data attribute on body
      if (State.variables.lens) {
        document.body.setAttribute("data-lens", State.variables.lens);
      }
      const html = render(src);
      const container = document.getElementById("passages");
      container.innerHTML = `<div class="passage">${html}</div>`;
      container.scrollTop = 0;
      window.scrollTo(0, 0);
    }
  };
  window.Engine = Engine;

  /* ── Boot ─────────────────────────────────────────────────────── */
  document.addEventListener("DOMContentLoaded", () => {
    loadPassages();
    const sd = document.querySelector("tw-storydata");
    const start = sd ? sd.getAttribute("startnode") : null;
    let startName = "ChooseLens";
    if (start) {
      const el = sd.querySelector(`tw-passagedata[pid="${start}"]`);
      if (el) startName = el.getAttribute("name");
    }
    Engine.play(startName);
  });
})();
</script>

<style>
/* ── Base styles ────────────────────────────────────────────────── */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: Georgia, 'Times New Roman', serif;
  background: #1a1a2e;
  color: #e0e0e0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 2rem 1rem;
}

#passages {
  max-width: 700px;
  width: 100%;
}

.passage {
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  padding: 2rem;
  line-height: 1.7;
}

.passage h1, .passage h2 { margin-bottom: 1rem; }
.passage h2 { font-size: 1.4rem; }
.passage p { margin-bottom: 0.8rem; }

a.link-internal {
  color: #64b5f6;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s;
}
a.link-internal:hover { color: #90caf9; }

.choice-grid {
  display: grid;
  gap: 0.5rem;
  margin: 1rem 0;
}

.choice-grid a.link-internal {
  display: block;
  background: rgba(100, 181, 246, 0.1);
  border: 1px solid rgba(100, 181, 246, 0.3);
  border-radius: 6px;
  padding: 0.8rem 1rem;
  text-decoration: none;
  transition: background 0.2s, border-color 0.2s;
}
.choice-grid a.link-internal:hover {
  background: rgba(100, 181, 246, 0.2);
  border-color: rgba(100, 181, 246, 0.6);
}

.spinner {
  display: inline-block;
  width: 24px; height: 24px;
  border: 3px solid rgba(255,255,255,0.2);
  border-top-color: #64b5f6;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  vertical-align: middle;
  margin-right: 0.5rem;
}
@keyframes spin { to { transform: rotate(360deg); } }

.room-nav {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px;
  padding: 1rem;
  margin: 1rem 0;
}
.room-nav h3 { font-size: 1rem; margin-bottom: 0.5rem; opacity: 0.8; }

.param-display {
  font-family: 'Courier New', monospace;
  background: rgba(0,0,0,0.3);
  padding: 1rem;
  border-radius: 4px;
  margin: 1rem 0;
  font-size: 0.9rem;
}

.marginalia {
  float: right;
  width: 180px;
  font-size: 0.8rem;
  opacity: 0.6;
  font-style: italic;
  padding-left: 1rem;
  border-left: 2px solid rgba(255,255,255,0.1);
  margin-left: 1rem;
}

/* ── Kathryn Cramer lens ─────────────────────────────────────── */
body[data-lens="cramer"] {
  background: #2c1810;
  color: #e8dcc8;
  font-family: 'Palatino Linotype', Palatino, Georgia, serif;
}
body[data-lens="cramer"] .passage {
  background: rgba(232, 220, 200, 0.08);
  border: 1px solid rgba(232, 220, 200, 0.15);
}
body[data-lens="cramer"] a.link-internal { color: #d4a574; }
body[data-lens="cramer"] a.link-internal:hover { color: #e8c49a; }
body[data-lens="cramer"] .choice-grid a.link-internal {
  border-color: rgba(212, 165, 116, 0.3);
  background: rgba(212, 165, 116, 0.08);
}
body[data-lens="cramer"] .choice-grid a.link-internal:hover {
  background: rgba(212, 165, 116, 0.18);
}

/* ── Mordvintsev lens ───────────────────────────────────────── */
body[data-lens="mordvintsev"] {
  background: #0d0221;
  color: #c8e6c9;
  font-family: 'Segoe UI', Tahoma, Geneva, sans-serif;
}
body[data-lens="mordvintsev"] .passage {
  background: rgba(76, 175, 80, 0.05);
  border: 1px solid rgba(76, 175, 80, 0.15);
}
body[data-lens="mordvintsev"] a.link-internal { color: #69f0ae; }
body[data-lens="mordvintsev"] a.link-internal:hover { color: #b9f6ca; }
body[data-lens="mordvintsev"] .choice-grid a.link-internal {
  border-color: rgba(105, 240, 174, 0.3);
  background: rgba(105, 240, 174, 0.05);
}

/* ── Sayama lens ────────────────────────────────────────────── */
body[data-lens="sayama"] {
  background: #f5f5f5;
  color: #212121;
  font-family: 'Helvetica Neue', Arial, sans-serif;
}
body[data-lens="sayama"] .passage {
  background: #ffffff;
  border: 1px solid #e0e0e0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
body[data-lens="sayama"] a.link-internal { color: #1565c0; }
body[data-lens="sayama"] a.link-internal:hover { color: #0d47a1; }
body[data-lens="sayama"] .choice-grid a.link-internal {
  border-color: #bbdefb;
  background: #e3f2fd;
  color: #1565c0;
}
body[data-lens="sayama"] .param-display {
  background: #e8eaf6;
  color: #212121;
}

/* ── Wolfram lens ───────────────────────────────────────────── */
body[data-lens="wolfram"] {
  background: #111111;
  color: #ff9800;
  font-family: 'Courier New', Courier, monospace;
}
body[data-lens="wolfram"] .passage {
  background: rgba(255, 152, 0, 0.04);
  border: 1px solid rgba(255, 152, 0, 0.2);
}
body[data-lens="wolfram"] a.link-internal { color: #ffb74d; }
body[data-lens="wolfram"] a.link-internal:hover { color: #ffe0b2; }
body[data-lens="wolfram"] .choice-grid a.link-internal {
  border-color: rgba(255, 183, 77, 0.3);
  background: rgba(255, 152, 0, 0.06);
  font-family: 'Courier New', monospace;
}

/* ── Rucker lens ────────────────────────────────────────────── */
body[data-lens="rucker"] {
  background: #0a0020;
  color: #e0e0ff;
  font-family: 'Comic Sans MS', 'Chalkboard SE', cursive, sans-serif;
}
body[data-lens="rucker"] .passage {
  background: linear-gradient(135deg, rgba(255,0,128,0.06), rgba(0,128,255,0.06));
  border: 1px solid rgba(255, 0, 128, 0.2);
}
body[data-lens="rucker"] a.link-internal { color: #ff4081; }
body[data-lens="rucker"] a.link-internal:hover { color: #ff80ab; }
body[data-lens="rucker"] .choice-grid a.link-internal {
  border-color: rgba(255, 64, 129, 0.3);
  background: linear-gradient(90deg, rgba(255,0,128,0.08), rgba(0,200,255,0.08));
}

/* ── Mandelbrot lens ────────────────────────────────────────── */
body[data-lens="mandelbrot"] {
  background: #0a0a2e;
  color: #ffd54f;
  font-family: 'Garamond', 'Times New Roman', serif;
}
body[data-lens="mandelbrot"] .passage {
  background: rgba(255, 213, 79, 0.04);
  border: 1px solid rgba(255, 213, 79, 0.15);
}
body[data-lens="mandelbrot"] a.link-internal { color: #ffd54f; }
body[data-lens="mandelbrot"] a.link-internal:hover { color: #ffecb3; }
body[data-lens="mandelbrot"] .choice-grid a.link-internal {
  border-color: rgba(255, 213, 79, 0.3);
  background: rgba(255, 213, 79, 0.05);
}

/* ── John Cramer lens ───────────────────────────────────────── */
body[data-lens="jcramer"] {
  background: #1b1b1b;
  color: #b0bec5;
  font-family: 'Lucida Console', 'Menlo', monospace;
}
body[data-lens="jcramer"] .passage {
  background: rgba(0, 200, 83, 0.04);
  border: 1px solid rgba(0, 200, 83, 0.15);
}
body[data-lens="jcramer"] a.link-internal { color: #00c853; }
body[data-lens="jcramer"] a.link-internal:hover { color: #69f0ae; }
body[data-lens="jcramer"] .choice-grid a.link-internal {
  border-color: rgba(0, 200, 83, 0.3);
  background: rgba(0, 200, 83, 0.05);
  font-family: 'Lucida Console', monospace;
}
body[data-lens="jcramer"] .param-display {
  background: #0a0a0a;
  color: #00c853;
  border: 1px solid rgba(0, 200, 83, 0.2);
}

/* ── Pelton lens ────────────────────────────────────────────── */
body[data-lens="pelton"] {
  background: #1a1008;
  color: #d4c4a0;
  font-family: 'Trebuchet MS', 'Arial Narrow', sans-serif;
}
body[data-lens="pelton"] .passage {
  background: rgba(210, 160, 60, 0.06);
  border: 1px solid rgba(210, 160, 60, 0.2);
}
body[data-lens="pelton"] a.link-internal { color: #e6a817; }
body[data-lens="pelton"] a.link-internal:hover { color: #ffd54f; }
body[data-lens="pelton"] .choice-grid a.link-internal {
  border-color: rgba(230, 168, 23, 0.3);
  background: rgba(210, 160, 60, 0.08);
}
body[data-lens="pelton"] .param-display {
  background: rgba(20, 10, 0, 0.5);
  color: #e6a817;
  border: 1px solid rgba(210, 160, 60, 0.2);
}

/* ── Womack lens ────────────────────────────────────────────── */
body[data-lens="womack"] {
  background: #0e0e12;
  color: #8a8a9a;
  font-family: 'Baskerville', 'Georgia', serif;
}
body[data-lens="womack"] .passage {
  background: rgba(138, 138, 154, 0.04);
  border: 1px solid rgba(138, 138, 154, 0.12);
}
body[data-lens="womack"] a.link-internal { color: #a0a0c0; }
body[data-lens="womack"] a.link-internal:hover { color: #c8c8e0; }
body[data-lens="womack"] .choice-grid a.link-internal {
  border-color: rgba(160, 160, 192, 0.2);
  background: rgba(138, 138, 154, 0.05);
}
body[data-lens="womack"] .param-display {
  background: rgba(0, 0, 0, 0.4);
  color: #7a7a8a;
  border: 1px solid rgba(138, 138, 154, 0.1);
}
</style>
</head>
<body>
<div id="passages"></div>

<tw-storydata name="Experiment Designer" startnode="1" creator="Twine" format="custom" format-version="1.0.0">

<!-- ═══════════════════════════════════════════════════════════════
     PASSAGE 1: ChooseLens
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="1" name="ChooseLens">
<h1>Experiment Designer</h1>
<h2>Choose Your Lens</h2>

Each lens shapes how you see the robot, its parameters, and its behavior. The simulation underneath is identical — what changes is the frame of interpretation.

<div class="choice-grid">
<<link "Kathryn Cramer — Hypertext Pedagogy" "Lobby">><<set $lens to "cramer">><</link>>

<<link "Mordvintsev — Active Interpretability" "ChooseAmplitude">><<set $lens to "mordvintsev">><</link>>

<<link "Sayama — Complex Systems Modeling" "ChooseAmplitude">><<set $lens to "sayama">><</link>>

<<link "Wolfram — Computational Universe" "ChooseAmplitude">><<set $lens to "wolfram">><</link>>

<<link "Rucker — Higher-Dimensional Creatures" "ChooseAmplitude">><<set $lens to "rucker">><</link>>

<<link "Mandelbrot — Multi-Scale Structure" "ChooseAmplitude">><<set $lens to "mandelbrot">><</link>>

<<link "John Cramer — Experimental Physics" "ChooseAmplitude">><<set $lens to "jcramer">><</link>>

<<link "Robert Young Pelton — Survival Expeditions" "ChooseAmplitude">><<set $lens to "pelton">><</link>>

<<link "Jack Womack — Dystopian Lifelines" "ChooseAmplitude">><<set $lens to "womack">><</link>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     KATHRYN CRAMER: Lobby (hub room)
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="2" name="Lobby">
<<if $lens eq "cramer">>
<h2>The Lobby</h2>

<div class="marginalia">You are here: the central hall of the Gait Design Institute. Doors lead to specialized rooms. You may visit them in any order. Each room lets you configure one aspect of your robot's motion.</div>

You stand in a high-ceilinged lobby. The floor is tiled with a mosaic depicting a walking quadruped, its legs frozen mid-stride. Around you, doorways open into specialized chambers.

A brass plaque on the wall reads: //Configure your experiment by visiting the rooms. Return here at any time.//

<div class="room-nav">
<h3>Rooms</h3>
<div class="choice-grid">
[[Enter the Range-Mapping Gallery (Amplitude)|CramerAmplitude]]
[[Enter the Oscillation Chamber (Frequency)|CramerFrequency]]
[[Enter the Offset Workshop (Leg Offsets)|CramerOffsets]]
[[Enter the Force Vault (Motor Force)|CramerForce]]
[[Visit the Sensor Room|SensorRoom]]
[[Walk the Physics Corridor|PhysicsCorridor]]
</div>
</div>

<div class="param-display">
Current Configuration:
  Amplitude:    <<if $amplitude>>$amplitude rad<<else>>not set<</if>>
  Frequency:    <<if $frequency>>$frequency Hz<<else>>not set<</if>>
  Back Offset:  <<if $back_offset>>$back_offset rad<<else>>not set<</if>>
  Front Offset: <<if $front_offset>>$front_offset rad<<else>>not set<</if>>
  Max Force:    <<if $max_force>>$max_force N<<else>>not set<</if>>
</div>

<<if $amplitude>><<if $frequency>><<if $max_force>>
All parameters are set. [[Proceed to the Observation Deck (Review)|Review]]
<</if>><</if>><</if>>
<</if>>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     KATHRYN CRAMER: Sensor Room
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="3" name="SensorRoom">
<h2>The Sensor Room</h2>

<div class="marginalia">Pedagogical note: The robot senses joint angles and contact forces. These are its only windows onto the world. Everything it "knows" comes through these channels.</div>

Glass cases line the walls, each containing a different sensor module. A docent's voice echoes from hidden speakers:

"Your robot has proprioceptive sensors in each joint — they measure the current angle, how fast it's changing, and the torque being applied. It also has contact sensors on its feet that fire when they touch the ground."

"The robot doesn't see. It doesn't hear. It feels its own body and the ground beneath it. Every behavior you observe emerges from this minimal sensorium."

A side door leads to the Motor Room, where signals become motion.

<div class="choice-grid">
[[Continue to the Motor Room|MotorRoom]]
[[Return to the Lobby|Lobby]]
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     KATHRYN CRAMER: Motor Room
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="4" name="MotorRoom">
<h2>The Motor Room</h2>

<div class="marginalia">The motor controller converts desired angles into forces. It's a position controller — you tell it where the joint should be, and it pushes to get there. The "max force" parameter caps how hard it can push.</div>

Massive diagrams cover the walls showing sine waves, phase relationships, and joint angle trajectories. A mechanical model in the center of the room slowly articulates a two-joint leg, its motors humming.

"Each joint follows a sine wave," the placard reads. "The //amplitude// controls how far each swing goes. The //frequency// controls how fast. //Offsets// shift the center point of the swing. And the //phase// relationship between front and back legs determines whether the robot crawls, hops, or stumbles."

"In this experiment, the back leg starts at phase 0 and the front leg at phase pi — they move in anti-phase, like a natural walking gait."

<div class="choice-grid">
[[Set the Amplitude|CramerAmplitude]]
[[Set the Frequency|CramerFrequency]]
[[Return to the Lobby|Lobby]]
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     KATHRYN CRAMER: Physics Corridor
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="5" name="PhysicsCorridor">
<h2>The Physics Corridor</h2>

<div class="marginalia">The simulation runs at 240 Hz. Gravity is -9.8 m/s^2. Friction coefficients are set high (2.0-2.5) to prevent sliding.</div>

The corridor is long and slightly inclined. Windows on one side show a PyBullet world — a flat plane stretching to the horizon, gravity pulling everything down at 9.8 m/s squared.

Plaques along the wall explain:

''Friction:'' "The ground and the robot's feet have high friction coefficients. This means the robot grips the surface well — it won't slide. But it also means that poorly configured gaits will catch and stumble rather than glide."

''Gravity:'' "Standard Earth gravity. Your robot weighs what it weighs. More force means it can fight gravity harder, but too much force with too much amplitude will flip it."

''Time:'' "The physics engine ticks 240 times per second. A simulation of 1000 steps is about 4.2 seconds of robot time."

<div class="choice-grid">
[[Set the Motor Force|CramerForce]]
[[Return to the Lobby|Lobby]]
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     CRAMER: Amplitude Room
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="6" name="CramerAmplitude">
<h2>The Range-Mapping Gallery</h2>

<div class="marginalia">Amplitude maps directly to stride length — but the relationship is nonlinear. Too much amplitude and the robot's legs overshoot, causing instability.</div>

Four dials on the wall, each set to a different amplitude. Beside each, a sketch shows the expected leg swing arc.

<div class="choice-grid">
<<link "0.4 rad — Cautious steps, small arcs" "Lobby">><<set $amplitude to 0.4>><</link>>
<<link "0.7 rad — Moderate stride, balanced" "Lobby">><<set $amplitude to 0.7>><</link>>
<<link "1.1 rad — Long stride, aggressive" "Lobby">><<set $amplitude to 1.1>><</link>>
<<link "1.6 rad — Maximum reach, risky" "Lobby">><<set $amplitude to 1.6>><</link>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     CRAMER: Frequency Room
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="7" name="CramerFrequency">
<h2>The Oscillation Chamber</h2>

<div class="marginalia">Frequency and amplitude interact: high frequency with high amplitude demands enormous motor torque. The motor may not keep up.</div>

Metronomes of different speeds tick along a shelf. Each one drives a small mechanical leg model at its tempo.

<div class="choice-grid">
<<link "0.8 Hz — Slow, deliberate cadence" "Lobby">><<set $frequency to 0.8>><</link>>
<<link "1.5 Hz — Walking pace" "Lobby">><<set $frequency to 1.5>><</link>>
<<link "2.5 Hz — Brisk trot" "Lobby">><<set $frequency to 2.5>><</link>>
<<link "4.0 Hz — Rapid scurry" "Lobby">><<set $frequency to 4.0>><</link>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     CRAMER: Offsets Room
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="8" name="CramerOffsets">
<h2>The Offset Workshop</h2>

<div class="marginalia">Offsets shift the "resting position" of each joint. They determine posture — whether the robot leans forward, stands neutral, or leans back. Asymmetric offsets create directional bias.</div>

Workbenches hold adjustable leg models. Each is set to a different resting posture.

<div class="choice-grid">
<<link "Neutral (back: 0.0, front: 0.0)" "Lobby">><<set $back_offset to 0.0>><<set $front_offset to 0.0>><</link>>
<<link "Forward-leaning (back: 0.2, front: -0.3)" "Lobby">><<set $back_offset to 0.2>><<set $front_offset to -0.3>><</link>>
<<link "Aggressive (back: 0.5, front: -0.5)" "Lobby">><<set $back_offset to 0.5>><<set $front_offset to -0.5>><</link>>
<<link "Backward-leaning (back: -0.3, front: 0.2)" "Lobby">><<set $back_offset to -0.3>><<set $front_offset to 0.2>><</link>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     CRAMER: Force Room
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="9" name="CramerForce">
<h2>The Force Vault</h2>

<div class="marginalia">Force is the motor's budget. Too little and the legs can't follow the trajectory. Too much and the robot may jerk violently at direction changes.</div>

Three massive springs are mounted to the wall, each labeled with its maximum output.

<div class="choice-grid">
<<link "120 N — Gentle, may struggle with large amplitudes" "Lobby">><<set $max_force to 120>><</link>>
<<link "350 N — Standard, reliable for most gaits" "Lobby">><<set $max_force to 350>><</link>>
<<link "600 N — Powerful, risks instability at high amplitude" "Lobby">><<set $max_force to 600>><</link>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     COMMON: ChooseAmplitude (non-Cramer lenses)
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="10" name="ChooseAmplitude">
<<if $lens eq "mordvintsev">>
<h2>Growth Amplitude</h2>

The growth amplitude — how far each developmental cycle reaches into the space of possible joint configurations. A small amplitude means the pattern barely perturbs the resting state. A large one means the self-organizing process swings wide, exploring the extremes.

<<elseif $lens eq "sayama">>
<h2>Variable 1: Amplitude</h2>

''Hypothesis:'' Amplitude controls stride length. Larger amplitude should produce longer strides, but may decrease stability beyond a threshold.

Select a value to test:

<<elseif $lens eq "wolfram">>
<h2>Rule Parameter 1/4: Amplitude</h2>

Amplitude &isin; {0.4, 0.7, 1.1, 1.6} rad. This parameter sets the excursion range of the joint oscillator. Select:

<<elseif $lens eq "rucker">>
<h2>How Wild?</h2>

How far should your creature's legs swing through phase space? A timid creature barely moves. A wild one throws its limbs to the edges of configuration space and sees what happens.

<<elseif $lens eq "mandelbrot">>
<h2>Characteristic Scale of Oscillation</h2>

The amplitude sets the characteristic scale of the joint trajectory. Larger values produce rougher, more jagged motion paths — the trajectory's fractal dimension increases with amplitude.

<<elseif $lens eq "jcramer">>
<h2>Motor Excursion Range</h2>

Motor excursion range (&plusmn;rad). Instrument limit: 1.8 rad.
Calibration note: Joint encoder resolution is 0.001 rad. Values below 0.3 rad approach the noise floor of the position controller.

<<elseif $lens eq "pelton">>
<h2>Range of Motion — Threat Assessment</h2>

How far can this thing reach? In the field, the difference between a cautious shuffle and a full leg extension is the difference between getting across the wire and getting caught on it. Small movements keep you low and quiet. Big swings cover ground fast but you're exposed. Pick your risk tolerance.

<<elseif $lens eq "womack">>
<h2>Amplitude</h2>

The range of the permitted gesture. In the reduced city the body learns how far it may extend before the architecture corrects it. A small amplitude: the walk of someone who knows the walls. A large one: the reach of someone who has forgotten what waits at the edges.

<<else>>
<h2>Choose Amplitude</h2>

Select the amplitude of joint oscillation (radians):
<</if>>

<div class="choice-grid">
<<link "0.4 rad" "ChooseFrequency">><<set $amplitude to 0.4>><</link>>
<<link "0.7 rad" "ChooseFrequency">><<set $amplitude to 0.7>><</link>>
<<link "1.1 rad" "ChooseFrequency">><<set $amplitude to 1.1>><</link>>
<<link "1.6 rad" "ChooseFrequency">><<set $amplitude to 1.6>><</link>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     COMMON: ChooseFrequency
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="11" name="ChooseFrequency">
<<if $lens eq "mordvintsev">>
<h2>Oscillation Tempo</h2>

The tempo of the developmental cycle — how rapidly the growth pattern iterates. Faster iteration means more cycles per unit time, each one reinforcing or destabilizing the emergent pattern.

<<elseif $lens eq "sayama">>
<h2>Variable 2: Frequency</h2>

''Prediction:'' Higher frequency should increase stepping rate. Combined with amplitude, this determines the speed-stability tradeoff.

Select frequency (Hz):

<<elseif $lens eq "wolfram">>
<h2>Rule Parameter 2/4: Frequency</h2>

Frequency &isin; {0.8, 1.5, 2.5, 4.0} Hz. Oscillation rate of the joint controller:

<<elseif $lens eq "rucker">>
<h2>How Fast?</h2>

Your creature's metabolism — the clock speed of its limb oscillations. Slow and lumbering, or fast and frantic? The manifold of possible gaits looks very different at each tempo.

<<elseif $lens eq "mandelbrot">>
<h2>Temporal Frequency</h2>

The fundamental frequency of the time series. Higher frequencies pack more oscillation cycles into the observation window, increasing the temporal complexity of the trajectory.

<<elseif $lens eq "jcramer">>
<h2>Oscillation Frequency</h2>

Drive frequency (Hz). Instrument bandwidth: 0.1–10.0 Hz.
Note: Motor servo loop runs at 240 Hz. Nyquist limit for resolved gait dynamics: 120 Hz. All test frequencies are well within band.

<<elseif $lens eq "pelton">>
<h2>Pace — How Fast Are You Moving?</h2>

Tempo is everything. Slow means you can read the terrain, pick your footing, react to surprises. Fast means you outrun the problem — or you don't see the hole until you're in it. I've watched guys sprint across minefields and live, and I've watched careful people step wrong once. Choose your cadence.

<<elseif $lens eq "womack">>
<h2>Frequency</h2>

The repetition rate of the body's single available phrase. Slow: the pace of someone conserving what remains. Fast: the pace of someone who has heard something behind them. The city's rhythm was never chosen. It was inherited from whatever came before the collapse.

<<else>>
<h2>Choose Frequency</h2>

Select the oscillation frequency (Hz):
<</if>>

<div class="choice-grid">
<<link "0.8 Hz" "ChooseOffsets">><<set $frequency to 0.8>><</link>>
<<link "1.5 Hz" "ChooseOffsets">><<set $frequency to 1.5>><</link>>
<<link "2.5 Hz" "ChooseOffsets">><<set $frequency to 2.5>><</link>>
<<link "4.0 Hz" "ChooseOffsets">><<set $frequency to 4.0>><</link>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     COMMON: ChooseOffsets
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="12" name="ChooseOffsets">
<<if $lens eq "mordvintsev">>
<h2>Positional Bias</h2>

The bias field — an asymmetry in the growth pattern that tilts the organism's posture. Like a gradient in a neural field, it determines the default direction of flow.

<<elseif $lens eq "sayama">>
<h2>Variable 3: Joint Offsets</h2>

''Hypothesis:'' Offset asymmetry between front and back legs should create directional locomotion bias. Symmetric offsets should produce in-place oscillation.

<<elseif $lens eq "wolfram">>
<h2>Rule Parameter 3/4: Offsets</h2>

Joint offset presets. These shift the DC component of the sine controller for each leg:

<<elseif $lens eq "rucker">>
<h2>How Crooked?</h2>

Your creature's posture — its default lean, its characteristic slouch or swagger. A neutral creature is symmetrical. An offset creature has attitude, a built-in direction.

<<elseif $lens eq "mandelbrot">>
<h2>Positional Offset</h2>

The DC component of the oscillation — a translation in configuration space. Asymmetric offsets break the bilateral symmetry and create directional bias in the trajectory.

<<elseif $lens eq "jcramer">>
<h2>Joint DC Offset</h2>

Servo zero-point bias (rad). These offsets shift the center of oscillation for each joint. Calibration reference: mechanical zero confirmed via limit switches.

<<elseif $lens eq "pelton">>
<h2>Stance — Which Way Are You Leaning?</h2>

Posture determines direction. Neutral stance keeps your options open — you can go any way. Forward lean means you're committed: faster off the mark, harder to stop. Aggressive lean is a sprint posture — great for getting out of somewhere, terrible for changing your mind. Backward lean? That's a fighting retreat. Sometimes it's the right call.

<<elseif $lens eq "womack">>
<h2>Offset</h2>

The body's permanent inclination. Neutral: a posture no one holds for long. Forward: the lean of someone moving toward something that may not still be there when they arrive. Backward: the lean of someone who has already seen what's ahead. Every survivor walks crooked. The question is which direction.

<<else>>
<h2>Choose Offsets</h2>

Select a leg offset preset:
<</if>>

<div class="choice-grid">
<<link "Neutral (0.0 / 0.0)" "ChooseForce">><<set $back_offset to 0.0>><<set $front_offset to 0.0>><</link>>
<<link "Forward-leaning (0.2 / -0.3)" "ChooseForce">><<set $back_offset to 0.2>><<set $front_offset to -0.3>><</link>>
<<link "Aggressive (0.5 / -0.5)" "ChooseForce">><<set $back_offset to 0.5>><<set $front_offset to -0.5>><</link>>
<<link "Backward-leaning (-0.3 / 0.2)" "ChooseForce">><<set $back_offset to -0.3>><<set $front_offset to 0.2>><</link>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     COMMON: ChooseForce
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="13" name="ChooseForce">
<<if $lens eq "mordvintsev">>
<h2>Growth Energy</h2>

The energy available for pattern formation — how much force the developmental process can exert on the substrate. Too little energy and the pattern dissolves. Too much and it shatters into chaos.

<<elseif $lens eq "sayama">>
<h2>Variable 4: Motor Force</h2>

''Control variable:'' Maximum motor force constrains the system's ability to follow the commanded trajectory. Insufficient force = trajectory tracking error.

<<elseif $lens eq "wolfram">>
<h2>Rule Parameter 4/4: Force</h2>

MAX_FORCE &isin; {120, 350, 600} N. Motor torque limit:

<<elseif $lens eq "rucker">>
<h2>How Strong?</h2>

Your creature's muscle power. A weak creature moves gently, its legs drifting through the commanded positions like suggestions. A strong creature snaps to each target with authority — maybe too much authority.

<<elseif $lens eq "mandelbrot">>
<h2>Force Scale</h2>

The force parameter sets an upper bound on the motor's output. It acts as a regularizer on the trajectory — higher force allows the trajectory to track the commanded sine more faithfully, producing sharper corners and higher-frequency content.

<<elseif $lens eq "jcramer">>
<h2>Motor Force Limit</h2>

Maximum motor force (N). Actuator spec sheet: continuous rated force 650 N, peak 800 N. Derating applied for thermal margin.

Test values within rated envelope:

<<elseif $lens eq "pelton">>
<h2>Power — How Hard Can You Push?</h2>

Force is your budget for surviving contact with reality. Too little and your legs are just suggestions — they'll fold under load, slip on wet ground, fail to pull you over an obstacle. Too much and you're burning energy you don't have, jerking yourself off balance, snapping tendons. The sweet spot depends on everything else. In my experience, people who survive usually have a little more force than they think they need.

<<elseif $lens eq "womack">>
<h2>Force</h2>

The ration of violence permitted to the limbs. A small force: the motors petition the joints and the joints consider it. A large force: the motors command and the joints comply instantly, brutally. In the old economy there was always enough force. Now you choose: gentle and slow, or fast and breaking.

<<else>>
<h2>Choose Force</h2>

Select the maximum motor force (N):
<</if>>

<div class="choice-grid">
<<link "120 N" "Review">><<set $max_force to 120>><</link>>
<<link "350 N" "Review">><<set $max_force to 350>><</link>>
<<link "600 N" "Review">><<set $max_force to 600>><</link>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     COMMON: Review
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="14" name="Review">
<<if $lens eq "cramer">>
<h2>The Observation Deck — Pre-Launch Review</h2>

<div class="marginalia">From this vantage point you can see the simulation floor below. Your robot waits in its starting position, motors primed with your chosen parameters.</div>

You stand at the railing of the observation deck. Below, the robot sits motionless on the simulation floor, its joints configured with your specifications.

<<elseif $lens eq "mordvintsev">>
<h2>Pattern Summary</h2>

The growth parameters are set. Before initiating the developmental process, review the configuration of your self-organizing system:

<<elseif $lens eq "sayama">>
<h2>Experiment Protocol — Review</h2>

Before running the experiment, verify your independent variables:

<<elseif $lens eq "wolfram">>
<h2>Rule Configuration Summary</h2>

All rule parameters specified. Configuration:

<<elseif $lens eq "rucker">>
<h2>Your Creature Awaits</h2>

Your creature is assembled, crouching at the edge of configuration space, ready to be released into the physics manifold. Here's what you've built:

<<elseif $lens eq "mandelbrot">>
<h2>Configuration at All Scales</h2>

The generator parameters are set. The resulting trajectory will have structure at multiple scales determined by these values:

<<elseif $lens eq "jcramer">>
<h2>Pre-Run Checklist</h2>

Instrument configuration verified. Run parameters:

<<elseif $lens eq "pelton">>
<h2>Pre-Mission Briefing</h2>

Here's your loadout. Look it over. Once you hit go, your robot is on its own — four seconds of simulated terrain with nothing but these parameters between it and the ground. No second chances in the field, but here you can always come back and refit.

<<elseif $lens eq "womack">>
<h2>Before</h2>

The configuration is fixed. These are the terms under which the body will be permitted to move. Review them. They will not be renegotiated once the process begins.

<</if>>

<div class="param-display">
  Amplitude:    $amplitude rad
  Frequency:    $frequency Hz
  Back Offset:  $back_offset rad
  Front Offset: $front_offset rad
  Max Force:    $max_force N
  Sim Steps:    1000
</div>

<div class="choice-grid">
<<link "Run Simulation" "RunSimulation">><</link>>

<<if $lens eq "cramer">>
<<link "Return to the Lobby to adjust" "Lobby">><</link>>
<<else>>
<<link "Go back and change amplitude" "ChooseAmplitude">><</link>>
<</if>>
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     COMMON: RunSimulation
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="15" name="RunSimulation">
<<if $lens eq "cramer">>
<h2>Launching Simulation...</h2>
<div class="marginalia">The robot is running on a headless PyBullet instance. No graphics — just physics, joints, and ground truth.</div>
<div class="spinner"></div> The simulation floor hums to life below. Your robot begins to move...
<<elseif $lens eq "mordvintsev">>
<h2>Growing...</h2>
<div class="spinner"></div> The developmental process unfolds. Patterns emerge from the initial conditions...
<<elseif $lens eq "sayama">>
<h2>Running Experiment...</h2>
<div class="spinner"></div> Simulation in progress. Collecting time-series data...
<<elseif $lens eq "wolfram">>
<h2>Computing...</h2>
<div class="spinner"></div> Evaluating rule configuration. Generating space-time evolution...
<<elseif $lens eq "rucker">>
<h2>Releasing Your Creature!</h2>
<div class="spinner"></div> Your creature tumbles into the physics manifold, limbs churning...
<<elseif $lens eq "mandelbrot">>
<h2>Iterating...</h2>
<div class="spinner"></div> The generator iterates, producing the trajectory at all scales...
<<elseif $lens eq "jcramer">>
<h2>Acquiring Data...</h2>
<div class="spinner"></div> DAQ active. Motors armed. Recording displacement telemetry...
<<elseif $lens eq "pelton">>
<h2>Deploying...</h2>
<div class="spinner"></div> Your robot hits the ground running. Or crawling. Or falling. We'll find out in a second...
<<elseif $lens eq "womack">>
<h2>Running</h2>
<div class="spinner"></div> The body moves through the allotted space. The ground receives it or doesn't.
<<else>>
<h2>Running...</h2>
<div class="spinner"></div> Simulation running...
<</if>>

<<script>>
(function() {
  var params = {
    amplitude: State.variables.amplitude || 0.7,
    frequency: State.variables.frequency || 1.5,
    back_offset: State.variables.back_offset || 0.0,
    front_offset: State.variables.front_offset || 0.0,
    max_force: State.variables.max_force || 350,
    sim_steps: 1000
  };
  fetch("/simulate", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(params)
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    State.variables.sim_result = data;
    if (data.summary) {
      var s = data.summary;
      var d = s.delta || s;
      State.variables.result_dx = (d.dx !== undefined && d.dx !== null) ? Number(d.dx).toFixed(3) : (s.dx !== undefined ? Number(s.dx).toFixed(3) : "N/A");
      State.variables.result_max_z = (s.max_z !== undefined && s.max_z !== null) ? Number(s.max_z).toFixed(3) : "N/A";
      State.variables.result_upright = (s.upright_fraction !== undefined && s.upright_fraction !== null) ? (Number(s.upright_fraction) * 100).toFixed(1) : "N/A";
      State.variables.result_max_roll = (s.max_abs_roll !== undefined) ? Number(s.max_abs_roll).toFixed(3) : "N/A";
      State.variables.result_max_pitch = (s.max_abs_pitch !== undefined) ? Number(s.max_abs_pitch).toFixed(3) : "N/A";

      // Determine salvage path flags for Cramer lens
      var dx_val = parseFloat(State.variables.result_dx);
      if (!isNaN(dx_val) && Math.abs(dx_val) < 0.05) {
        State.variables.salvage = "no_motion";
      } else if (!isNaN(dx_val) && dx_val < -0.05) {
        State.variables.salvage = "backward";
      } else if (s.upright_fraction !== undefined && s.upright_fraction !== null && Number(s.upright_fraction) < 0.5) {
        State.variables.salvage = "flipped";
      } else {
        State.variables.salvage = "none";
      }
    }
    Engine.play("Results");
  })
  .catch(function(err) {
    State.variables.sim_error = String(err);
    Engine.play("Error");
  });
})();
<</script>>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     COMMON: Results
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="16" name="Results">
<<if $lens eq "cramer">>
<h2>Observation Deck — Results</h2>

<<if $salvage eq "no_motion">>
<div class="marginalia">Your robot didn't move. A salvage path is available — a diagnostic room where you can understand why and adjust.</div>
From the observation deck you watch... and nothing happens. The robot vibrates slightly but stays in place. A red light blinks on the console: ''NO SIGNIFICANT DISPLACEMENT DETECTED.''

A door at the side of the deck is marked: //Salvage Path — Diagnostics//

<div class="param-display">
  Displacement:     $result_dx m
  Max Height:       $result_max_z m
  Upright Fraction: $result_upright%
  Max Roll:         $result_max_roll rad
  Max Pitch:        $result_max_pitch rad
</div>

<div class="choice-grid">
[[Enter the Salvage Path|SalvagePath_NoMotion]]
[[Return to the Lobby to try again|Lobby]]
</div>

<<elseif $salvage eq "backward">>
<div class="marginalia">The robot moved backward. The offset configuration pushed it the wrong way. Explore the salvage path to understand why.</div>
From the observation deck you watch your robot lurch... backward. It moves with purpose, but in the wrong direction. The displacement counter ticks into negative numbers.

<div class="param-display">
  Displacement:     $result_dx m (BACKWARD)
  Max Height:       $result_max_z m
  Upright Fraction: $result_upright%
</div>

<div class="choice-grid">
[[Enter the Salvage Path|SalvagePath_Backward]]
[[Return to the Lobby to adjust|Lobby]]
</div>

<<elseif $salvage eq "flipped">>
<div class="marginalia">The robot tipped over. It spent most of its run time on its back or side, unable to walk. Force and amplitude likely overwhelmed stability.</div>
From the observation deck you watch your robot tip, flail, and end up on its side. The upright indicator drops to red.

<div class="param-display">
  Displacement:     $result_dx m
  Max Height:       $result_max_z m
  Upright Fraction: $result_upright% (UNSTABLE)
  Max Roll:         $result_max_roll rad
  Max Pitch:        $result_max_pitch rad
</div>

<div class="choice-grid">
[[Enter the Salvage Path|SalvagePath_Flipped]]
[[Return to the Lobby to adjust|Lobby]]
</div>

<<else>>
<div class="marginalia">A pin appears on your map marking this gait configuration as "viable." You can bookmark this result and compare it with future runs.</div>
From the observation deck, you see your robot cross the simulation floor. Its legs cycle in the rhythm you specified, each stride carrying it forward.

A pin appears on your map. This gait is viable.

<div class="param-display">
  Displacement:     $result_dx m
  Max Height:       $result_max_z m
  Upright Fraction: $result_upright%
  Max Roll:         $result_max_roll rad
  Max Pitch:        $result_max_pitch rad
</div>

<div class="choice-grid">
[[Return to the Lobby for another experiment|Lobby]]
[[Start over with a new lens|ChooseLens]]
</div>
<</if>>

<<elseif $lens eq "mordvintsev">>
<h2>Emergent Pattern</h2>

The self-organizing pattern <<if $salvage eq "no_motion">>failed to sustain itself — the growth parameters produced a stationary fixed point rather than a traveling wave<<elseif $salvage eq "backward">>organized into a backward-propagating wave — the developmental gradient was inverted<<elseif $salvage eq "flipped">>destabilized and collapsed — the growth energy overwhelmed the substrate's capacity for coherent pattern formation<<else>>sustained itself across $result_dx meters of emergent locomotion. The developmental parameters produced a stable traveling wave, self-reinforcing through ground contact feedback<</if>>.

<div class="param-display">
  Displacement:     $result_dx m
  Max Height:       $result_max_z m
  Upright Fraction: $result_upright%
  Max Roll:         $result_max_roll rad
</div>

<div class="choice-grid">
[[Design another pattern|ChooseAmplitude]]
[[Choose a different lens|ChooseLens]]
</div>

<<elseif $lens eq "sayama">>
<h2>Experimental Results</h2>

''Measured outcome:''

<div class="param-display">
  Displacement (dx): $result_dx m
  Max Height (z):    $result_max_z m
  Upright Fraction:  $result_upright%
  Max Roll:          $result_max_roll rad
  Max Pitch:         $result_max_pitch rad
</div>

<<if $salvage eq "no_motion">>
''Analysis:'' The system produced negligible displacement. The chosen parameters may be below the locomotion threshold. Consider increasing amplitude or adjusting offsets.
<<elseif $salvage eq "backward">>
''Analysis:'' Negative displacement — the robot moved backward. The offset configuration created a directional bias opposite to the intended direction of travel. Reversing the offset signs should correct this.
<<elseif $salvage eq "flipped">>
''Analysis:'' The system became unstable (upright fraction below 50%). The force-amplitude product likely exceeded the stability envelope. Reducing either parameter should restore upright locomotion.
<<else>>
''Analysis:'' Forward locomotion achieved. Compare this result to your hypothesis. Was the displacement consistent with your prediction?
<</if>>

//TODO: Record observation, compare with ensemble, run statistical test.//

<div class="choice-grid">
[[Run another trial|ChooseAmplitude]]
[[Choose a different lens|ChooseLens]]
</div>

<<elseif $lens eq "wolfram">>
<h2>Rule Evaluation Complete</h2>

<div class="param-display">
  Displacement: $result_dx m
  Max Z:        $result_max_z m
  Upright:      $result_upright%
</div>

<<if $salvage eq "no_motion">>
''Classification:'' Class 1 behavior — fixed point. The rule produces a static configuration.
<<elseif $salvage eq "flipped">>
''Classification:'' Class 3 behavior — chaotic. The rule produces unbounded oscillation leading to instability.
<<elseif $salvage eq "backward">>
''Classification:'' Class 2 behavior — periodic but inverted. The rule produces consistent backward locomotion. Phase inversion detected.
<<else>>
''Classification:'' Class 2 behavior — periodic locomotion. Net displacement $result_dx m. Catalog entry updated.
<</if>>

//TODO: Rule space enumeration, atlas of behaviors, space-time trace visualization.//

<div class="choice-grid">
[[Evaluate another rule|ChooseAmplitude]]
[[Choose a different lens|ChooseLens]]
</div>

<<elseif $lens eq "rucker">>
<h2>Trip Report</h2>

<<if $salvage eq "no_motion">>
Your creature just... sat there. Vibrating slightly, like it was thinking about moving but couldn't commit. A meditation on potential energy, maybe. Or just stuck. Sometimes parameter space has potholes.
<<elseif $salvage eq "backward">>
Your creature surfed backward! $result_dx meters in the wrong direction. It looked confused but committed. Like a crab that forgot which way was forward. Beautiful in its own way.
<<elseif $salvage eq "flipped">>
Your creature flipped out — literally. It threw itself over and spent most of the run flailing on its back like a beetle. Too much energy, not enough stability. The phase space manifold has cliffs, and your creature found one.
<<else>>
Your creature surfed $result_dx meters across the manifold! A gnarly achievement in parameter space. Its legs churned through the oscillation pattern you specified, and the physics rewarded it with forward motion.
<</if>>

<div class="param-display">
  Distance surfed: $result_dx m
  Max altitude:    $result_max_z m
  Stayed upright:  $result_upright%
</div>

//TODO: Parameter space safari, weird gait bookmarks, manifold exploration.//

<div class="choice-grid">
[[Release another creature|ChooseAmplitude]]
[[Choose a different lens|ChooseLens]]
</div>

<<elseif $lens eq "mandelbrot">>
<h2>Trajectory Analysis</h2>

<div class="param-display">
  Displacement:  $result_dx m
  Max Height:    $result_max_z m
  Upright:       $result_upright%
  Max Roll:      $result_max_roll rad
  Max Pitch:     $result_max_pitch rad
</div>

<<if $salvage eq "no_motion">>
The trajectory collapsed to a point — zero effective displacement. The generator parameters produced a degenerate set with no spatial extent at the macroscopic scale. The oscillation existed but was self-canceling.
<<elseif $salvage eq "backward">>
$result_dx m displacement. The trajectory extended in the negative direction — a mirror image of the intended behavior. The boundary between forward and backward locomotion in parameter space has been located nearby.
<<elseif $salvage eq "flipped">>
The trajectory became unbounded in the vertical dimension. The max-z/dx ratio diverges, indicating a breakdown in the scaling relationship. The generator exceeded the stability boundary.
<<else>>
$result_dx m displacement. The trajectory roughness (max_z/dx ratio) suggests stable scaling behavior. The oscillation pattern maintained coherence across the full observation window.
<</if>>

//TODO: Zoomable time series, boundary scans, ensemble histograms.//

<div class="choice-grid">
[[Generate another trajectory|ChooseAmplitude]]
[[Choose a different lens|ChooseLens]]
</div>

<<elseif $lens eq "jcramer">>
<h2>Measurement Report</h2>

<div class="param-display">
  Measured displacement:  $result_dx m (&plusmn;0.001 m systematic)
  Maximum vertical:       $result_max_z m
  Upright fraction:       $result_upright%
  Max roll excursion:     $result_max_roll rad
  Max pitch excursion:    $result_max_pitch rad
  Contact noise floor:    nominal
</div>

<<if $salvage eq "no_motion">>
''Status:'' NULL RESULT. Displacement consistent with zero within systematic uncertainty. Motor commands were issued but did not produce net translation. Possible causes: insufficient force for commanded trajectory, symmetric offset cancellation, or resonance at natural frequency.
<<elseif $salvage eq "backward">>
''Status:'' NEGATIVE DISPLACEMENT. The instrument recorded motion opposite to the nominal forward direction. Offset polarity should be reviewed. Measurement is valid — the negative sign is physical, not instrumental.
<<elseif $salvage eq "flipped">>
''Status:'' STABILITY FAILURE. Upright fraction below 50% indicates the test article lost orientation control. Data after tip-over may not reflect intended gait dynamics. Recommend reducing force or amplitude for next run.
<<else>>
''Status:'' NOMINAL RUN. Displacement $result_dx m. Reconstruction residual within calibration bounds. All channels recorded successfully.
<</if>>

//TODO: Measurement pipeline view, null tests, calibration context, uncertainty breakdown.//

<div class="choice-grid">
[[Configure next run|ChooseAmplitude]]
[[Choose a different lens|ChooseLens]]
</div>

<<elseif $lens eq "pelton">>
<h2>After-Action Report</h2>

<<if $salvage eq "no_motion">>
Your robot didn't move. Zero displacement. I've seen this before — guy freezes at the border crossing, legs shaking, going nowhere. Not enough force, not enough asymmetry, or the stance was too neutral to commit to a direction. In the field this gets you caught. Refit and try again. More force, lean forward, commit to the direction.
<<elseif $salvage eq "backward">>
It moved — backward. $result_dx meters in the wrong direction. I once watched a Land Cruiser do this on a mountain switchback in Colombia. The driver had the wheels turned the wrong way. Your robot has the same problem: the offsets are pointing it the wrong direction. Flip the lean. Forward-leaning preset. Try again. The fix is simple if you survive the mistake.
<<elseif $salvage eq "flipped">>
Your robot flipped. Upright fraction: $result_upright%. That's a rollover. Too much power, too much swing, and the center of gravity said goodbye. I've rolled vehicles in worse places than this simulation. The survival strategy is the same: dial back the aggression. Less amplitude, less force. Stay low, stay upright, stay alive. You can't walk anywhere from your back.
<<else>>
$result_dx meters. Your robot made it. Not pretty, maybe, but forward motion across hostile terrain. In my experience, the gaits that work aren't elegant — they're stubborn. They keep the legs moving and the body upright and they grind out distance. That's what survival looks like: ugly, persistent forward progress.
<</if>>

<div class="param-display">
  Distance covered: $result_dx m
  Max height:       $result_max_z m
  Stayed upright:   $result_upright%
  Max roll:         $result_max_roll rad
  Max pitch:        $result_max_pitch rad
</div>

//TODO: Exploit catalog, improbable survival bookmarks, terrain threat assessment.//

<div class="choice-grid">
[[Run another expedition|ChooseAmplitude]]
[[Choose a different lens|ChooseLens]]
</div>

<<elseif $lens eq "womack">>
<h2>After</h2>

<<if $salvage eq "no_motion">>
The body did not move. The motors fired and the joints articulated and the displacement was zero. This is the most common outcome in the reduced city: effort without progress, motion without travel. The infrastructure for locomotion existed. The conditions for it did not. The body remains where it was placed.
<<elseif $salvage eq "backward">>
$result_dx meters. The negative sign means backward. The body moved away from where it was meant to go. In the old language this was called failure. In the current language it is called information. The offsets specified a direction and the direction was wrong. The body obeyed its instructions perfectly. The instructions were the problem.
<<elseif $salvage eq "flipped">>
The body lost orientation. Upright fraction: $result_upright%. It fell and did not recover. The force budget exceeded what the structure could metabolize. This is familiar: systems given more power than their architecture can organize will always destroy themselves. The fix is not more power. The fix is less ambition, or better structure. Neither is free.
<<else>>
$result_dx meters of displacement. The body moved forward through the space allotted to it. The gait held. The joints cycled. The ground did not refuse it. This is what passes for success: the body arrived somewhere other than where it started, still upright, still intact. The margin between this and failure was smaller than the numbers suggest.
<</if>>

<div class="param-display">
  Displacement: $result_dx m
  Max height:   $result_max_z m
  Upright:      $result_upright%
  Max roll:     $result_max_roll rad
  Max pitch:    $result_max_pitch rad
</div>

//TODO: Lifeline mapping, survival strategy archive, systemic failure genealogy.//

<div class="choice-grid">
[[Configure another body|ChooseAmplitude]]
[[Choose a different lens|ChooseLens]]
</div>

<</if>>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     CRAMER SALVAGE: No Motion
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="17" name="SalvagePath_NoMotion">
<h2>Salvage Path: No Motion Detected</h2>

<div class="marginalia">Diagnostic room. The simulation ran, the motors fired, but the robot didn't go anywhere. This is a common and informative failure mode.</div>

You enter a dimly lit diagnostic chamber. Screens replay your robot's run in slow motion — you can see the joints twitching, the legs moving, but the body going nowhere.

A diagnostic panel reads:

''Common causes of zero displacement:''

1. ''Insufficient force:'' If max force is too low relative to amplitude, the motors can't track the commanded trajectory. The legs move but don't push hard enough to move the body. //Try increasing force to 350N or above.//

2. ''Symmetric offsets:'' With both offsets at zero, the robot's leg swings are symmetric around the neutral position. This can produce oscillation without net forward motion. //Try the forward-leaning preset (0.2 / -0.3).//

3. ''Very low amplitude:'' At 0.4 rad, the leg swing may be too small to generate meaningful ground contact forces. //Try 0.7 or 1.1 rad.//

4. ''Very low frequency:'' At 0.8 Hz, the robot barely completes one gait cycle in 1000 steps. //Try 1.5 Hz or higher.//

<div class="choice-grid">
[[Return to the Lobby to adjust parameters|Lobby]]
[[Try a quick fix: moderate everything|QuickFix]]
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     CRAMER SALVAGE: Flipped
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="18" name="SalvagePath_Flipped">
<h2>Salvage Path: Robot Tipped Over</h2>

<div class="marginalia">The upright fraction tells you what percentage of the run the robot was "right side up." Below 50% means it spent more time on its side or back than walking.</div>

The replay shows your robot launch itself off the ground and tumble. The upright indicator drops immediately.

''What happened:''

The combination of high amplitude and high force created violent joint motions. At each direction change (the peaks and troughs of the sine wave), the motor snaps the joint to the target position with maximum force. This creates a jerk that rocks the body. If the rocking exceeds the robot's base of support, it tips.

''Fixes:''

1. ''Reduce amplitude:'' Drop from 1.6 to 0.7 rad. Smaller swings = less rocking.
2. ''Reduce force:'' Drop from 600 to 350 N. Gentler tracking = smoother motion.
3. ''Reduce frequency:'' Slower oscillation gives the body more time to settle between cycles.

The stability envelope is roughly: ''amplitude * force * frequency &lt; threshold''. All three contribute to instability.

<div class="choice-grid">
[[Return to the Lobby to adjust parameters|Lobby]]
[[Try a quick fix: moderate everything|QuickFix]]
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     CRAMER SALVAGE: Backward
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="19" name="SalvagePath_Backward">
<h2>Salvage Path: Backward Motion</h2>

<div class="marginalia">The sign of displacement tells you direction. Negative = backward in the simulation coordinate frame. The offset preset determines which way the robot "leans" and thus which way it pushes off.</div>

Your robot walked with conviction — in the wrong direction. The displacement counter shows a negative number.

''Why this happens:''

The joint offsets create a postural asymmetry. The "forward-leaning" preset tilts the legs so that ground contact happens preferentially on one side of the swing cycle. If you chose the "backward-leaning" preset (-0.3 / 0.2), the contact asymmetry points backward.

Think of it like this: the robot pushes off the ground at the bottom of each leg swing. The offset determines //where// the bottom is, and therefore //which direction// the push goes.

''Fix:'' Switch to the "forward-leaning" preset (0.2 / -0.3) or the "aggressive" preset (0.5 / -0.5). Both push the robot forward.

<div class="choice-grid">
[[Return to the Lobby to adjust offsets|Lobby]]
[[Try a quick fix: moderate everything|QuickFix]]
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     QuickFix (Cramer convenience)
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="20" name="QuickFix">
<<set $amplitude to 0.7>>
<<set $frequency to 1.5>>
<<set $back_offset to 0.2>>
<<set $front_offset to -0.3>>
<<set $max_force to 350>>

<h2>Quick Fix Applied</h2>

<div class="marginalia">These moderate parameters are a known-good starting point: enough amplitude to move, enough force to track, enough asymmetry to go forward.</div>

The diagnostic system has loaded a balanced configuration:

<div class="param-display">
  Amplitude:    0.7 rad
  Frequency:    1.5 Hz
  Back Offset:  0.2 rad
  Front Offset: -0.3 rad
  Max Force:    350 N
</div>

<div class="choice-grid">
[[Run with these parameters|RunSimulation]]
[[Return to the Lobby to fine-tune|Lobby]]
</div>
</tw-passagedata>

<!-- ═══════════════════════════════════════════════════════════════
     Error passage
     ═══════════════════════════════════════════════════════════════ -->
<tw-passagedata pid="21" name="Error">
<h2>Simulation Error</h2>

Something went wrong while running the simulation.

<<if $sim_error>>
''Error:'' $sim_error
<</if>>

This might mean the simulation server isn't running, or there was an internal error in PyBullet. Make sure the server is running:

<div class="param-display">
python3 twine/server.py
</div>

<div class="choice-grid">
[[Try again|RunSimulation]]
[[Start over|ChooseLens]]
</div>
</tw-passagedata>

</tw-storydata>
</body>
</html>
